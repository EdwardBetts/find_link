<html>
<head>
<title>
{% if q %}
    {{ q }} - Find link
{% else %}
    Find link
{% endif %}
</title>
<link rel="shortcut icon" href="{{url_for('static', filename='Link_edit.png')}}" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script> 
</head>
<style>
span.exact { padding: 2px; background: green; color: white; font-weight: bold; }
span.nomatch { padding: 2px; background: red; color: white; font-weight: bold; }
span.case_mismatch { padding: 2px; background: orange; color: white; font-weight: bold; }
span.searchmatch { font-weight: bold; }
.flash { font-weight: bold; }
</style>
<body>
<h1>Find link</h1>
{% if message %}
  <span class="flash">{{ message }}</span><br>
{% endif %}
<form action="{{url_for('index')}}">
<input name="q" value="{{ q }}" size="60">
<input type="submit" value="search">
{% if q %}
    {% set esc_q = urlquote(q.replace(' ', '_')) %}
    <script>
    api_url = 'http://en.wikipedia.org/w/api.php?format=json&callback=?&';
    function get_redirects () {
        url = api_url + "action=query&list=backlinks&blfilterredir=redirects&bllimit=500&blnamespace=0&bltitle={{esc_q}}";
        $.getJSON(url, function(data) {
            $('#result').html('<p>backlinks:' + data.query.backlinks + '</p>');
        });
    }
    </script>
    <a href="http://en.wikipedia.org/wiki/{{esc_q}}">view article</a>
{% endif %}
</form>
{% if q %}
    {% if longer_titles %}
        Longer titles found:
        {% for t in longer_titles %}
            {% set esc_title = urlquote(t.replace(' ', '_')) %}
            <a href="{{ url_for('findlink', q=t.replace(' ', '_'))}}">{{t}}</a> (<a href="http://en.wikipedia.org/wiki/{{esc_title}}">view</a>){{ ',' if not loop.last }}
        {% endfor %}<p>
    {% endif %}
    {% if redirect_to %}
        <b>{{ q }}</b> is a redirect to <b>{{ redirect_to }}</b><p>
    {% endif %}
    searching for {{ q }} {{ results | length }} found ({{totalhits}} total)<p>
    {% if q[0].isalpha() and results: %}
        {% set alt_case = case_flip_first(q) %}
        alternate case: <a href="{{url_for('findlink', q=urlquote(alt_case.replace(' ', '_')))}}">{{alt_case}}</a><p>
    {% endif %}
    {% if request.args.get('dev') %} 
        <a href="javascript:get_redirects()">redirect here</a><br>
        <div id="results"></div>
    {% endif %}
    {% for doc in results %}
        {# <pre>{{ doc | pprint() }}</pre> #}
        {% set esc_title = urlquote(doc.title.replace(' ', '_')) %}
        {% set params = 'q=' + urlquote(q) + '&title=' + urlquote(doc.title) %}
        {% if redirect_to %}
            {% set params = params + '&linkto=' + urlquote(redirect_to) %}
        {% endif %}
        <a href="{{url_for('index')}}?{{params}}" target="_blank">{{doc.title}}</a> ({{commify(doc.wordcount)}} words)
        {% if doc.match == 'exact' %}<span class="exact">exact match in snippet</span>{% endif %}
        {% if doc.match == 'case_mismatch' %}<span class="case_mismatch">case mismatch in snippet</span>{% endif %}
        {% if not doc.match %}<span class="nomatch">no match in snippet</span>{% endif %}
        <a href="http://en.wikipedia.org/wiki/{{esc_title}}" target="_blank">view article</a>
        <a href="{{url_for('findlink', q=doc.title.replace(' ', '_'))}}" target="_blank">find links to article</a>
        <br>
        <blockquote>{{ doc.snippet }}</blockquote>
    {% endfor %}
{% endif %}
</body>
</html>
